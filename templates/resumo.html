<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gestão Financeira Familiar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_resumo.css') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>

<div class="filtros">
    <form method="get" action="{{ url_for('resumo') }}">
        <label for="mes">Mês:</label>
        <input type="month" id="mes" name="mes" value="{{ filtro_mes or '' }}">
        &nbsp;&nbsp;
        <label for="pago">Pago:</label>
        <select id="pago" name="pago">
            <option value="" {% if not filtro_pago %}selected{% endif %}>Todos</option>
            <option value="sim" {% if filtro_pago == 'sim' %}selected{% endif %}>Sim</option>
            <option value="nao" {% if filtro_pago == 'nao' %}selected{% endif %}>Não</option>
        </select>
        &nbsp;&nbsp;
        <button type="submit">Filtrar</button>
    </form>
</div>

<!-- Botão de voltar -->
<div style="margin: 20px;">
    <a href="{{ url_for('index') }}">
        <button style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ← Voltar para a Tela Principal
        </button>
    </a>
</div>

<div class="graficos">
    <div>
        <h3>Despesas por Categoria</h3>
        <canvas id="pizzaCategorias" width="400" height="400"></canvas>
    </div>

    <div>
        <h3>Receitas e Despesas por Cartão</h3>
        <canvas id="barrasCartoes" width="600" height="400"></canvas>
    </div>
</div>

<!-- Bibliotecas necessárias -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
    // Pizza categorias
    const ctxPizza = document.getElementById('pizzaCategorias').getContext('2d');
    const labelsCategorias = {{ labels_categorias|tojson }};
    const valoresCategorias = {{ valores_categorias|tojson }};

    const pizzaCategorias = new Chart(ctxPizza, {
        type: 'pie',
        data: {
            labels: labelsCategorias,
            datasets: [{
                data: valoresCategorias,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#66FF66', '#FF6666'
                ],
            }]
        },
        options: {
            responsive: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let perc = total > 0 ? (value / total * 100).toFixed(2) : 0;
                            return `${label}: R$ ${value.toFixed(2)} (${perc}%)`;
                        }
                    }
                },
                legend: {
                    position: 'right',
                },
                datalabels: {
                    formatter: (value, ctx) => {
                        let total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        let perc = total > 0 ? (value / total * 100).toFixed(2) : 0;
                        return perc + '%';
                    },
                    color: '#fff',
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Barras receitas e despesas por cartão
    const ctxBarras = document.getElementById('barrasCartoes').getContext('2d');
    const labelsCartoes = {{ labels_cartoes|tojson }};
    const valoresReceitas = {{ valores_receitas|tojson }};
    const valoresDespesas = {{ valores_despesas|tojson }};

    const barrasCartoes = new Chart(ctxBarras, {
        type: 'bar',
        data: {
            labels: labelsCartoes,
            datasets: [
                {
                    label: 'Receitas',
                    backgroundColor: '#36A2EB',
                    data: valoresReceitas,
                },
                {
                    label: 'Despesas',
                    backgroundColor: '#FF6384',
                    data: valoresDespesas,
                }
            ]
        },
        options: {
            responsive: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: { position: 'top' }
            }
        }
    });
</script>

</body>
</html>
