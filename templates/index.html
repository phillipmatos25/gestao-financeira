<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o Financeira Familiar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>
    <h1>Gest√£o Financeira</h1>

    <!-- Bot√µes de navega√ß√£o -->
    <div class="top-buttons">
        <a href="{{ url_for('cadastros') }}">
            <button class="btn-cadastros">Cadastros Gerais</button>
        </a>
        <a href="{{ url_for('resumo') }}">
            <button class="btn-resumo">Resumo</button>
        </a>
    </div>

    <!-- FILTROS DE M√äS E PAGAMENTO -->
    <form method="get" class="filtros-container">
        <div>
            <label for="mes">M√™s de Refer√™ncia:</label>
            <select name="mes" id="mes">
                <option value="" {% if not filtro_mes %}selected{% endif %}>Todos os Meses</option>
                {% for mes in ['2025-01','2025-02','2025-03','2025-04','2025-05','2025-06','2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'] %}
                    <option value="{{ mes }}" {% if filtro_mes == mes %}selected{% endif %}>
                        {{ mes[5:] }}/{{ mes[:4] }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="pago">Status Parcela:</label>
            <select name="pago" id="pago">
                <option value="" {% if not filtro_pago %}selected{% endif %}>Todos</option>
                <option value="sim" {% if filtro_pago == 'sim' %}selected{% endif %}>Pagos</option>
                <option value="nao" {% if filtro_pago == 'nao' %}selected{% endif %}>Pendentes</option>
            </select>
        </div>
        <div>
            <button type="submit">Filtrar</button>
        </div>
    </form>

    <!-- Caixas de Totais -->
    <div class="caixas-totais">
        <div class="caixa receita">
            <h3>Total de Receitas</h3>
            <p>{{ total_receitas | format_currency }}</p>
        </div>
        <div class="caixa despesa">
            <h3>Total de Despesas</h3>
            <p>{{ total_despesas | format_currency }}</p>
        </div>
    </div>

    <!-- FORMUL√ÅRIO DE INCLUS√ÉO/EDI√á√ÉO -->
    <form method="post" class="formulario">
        <input type="hidden" name="movimentacao_id" value="{{ movimentacao_edit.id if movimentacao_edit else '' }}">

        <div>
            <label for="data">Data Evento:</label>
            <input type="date" name="data" id="data"
                   value="{{ movimentacao_edit.data if movimentacao_edit else '' }}">
        </div>

        <div>
            <label for="data_pagamento">Vencimento:</label>
            <input type="date" name="data_pagamento" id="data_pagamento" required
                   value="{{ movimentacao_edit.data_pagamento if movimentacao_edit else '' }}">
        </div>

        <div>
            <label for="descricao">Descri√ß√£o:</label>
            <input type="text" name="descricao" id="descricao" placeholder="Descri√ß√£o" required
                   value="{{ movimentacao_edit.descricao if movimentacao_edit else '' }}">
        </div>

        <div>
            <label for="categoria">Categoria:</label>
            <select name="categoria" required>
                <option value="">Selecione...</option>
                {% for cat in categorias %}
                    <option value="{{ cat['id'] }}"
                        {% if movimentacao_edit and movimentacao_edit.categoria == cat['nome'] %}selected{% endif %}>
                        {{ cat['nome'] }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="cartao">Cart√£o:</label>
            <select name="cartao" id="cartao" required>
                <option value="" disabled {% if not movimentacao_edit %}selected{% endif %}>Cart√£o</option>
                {% for cartao in cartoes %}
                    <option value="{{ cartao['id'] }}"
                        {% if movimentacao_edit and movimentacao_edit.cartao and movimentacao_edit.cartao['nome'] == cartao['nome'] %}selected{% endif %}>
                        {{ cartao['bandeira'] }} ({{ cartao['nome'] }})
                    </option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label for="parcelas">Parcelas:</label>
            <input type="number" name="parcelas" id="parcelas" min="1"
                   value="{{ movimentacao_edit.parcelas if movimentacao_edit else 1 }}" required>
        </div>

        <div>
            <label for="valor">Valor (R$):</label>
            <input type="number" step="0.01" name="valor" id="valor" placeholder="Valor (R$)" required
                   value="{{ movimentacao_edit.valor if movimentacao_edit else '' }}">
        </div>

        <div>
            <label for="tipo">Tipo:</label>
            <select name="tipo" id="tipo" required>
                <option value="despesa" {% if movimentacao_edit and movimentacao_edit.tipo == 'despesa' %}selected{% endif %}>Despesa</option>
                <option value="receita" {% if movimentacao_edit and movimentacao_edit.tipo == 'receita' %}selected{% endif %}>Receita</option>
            </select>
        </div>

        <div>
            <button type="submit" class="btn-incluir">
                {{ 'Salvar Altera√ß√µes' if movimentacao_edit else 'Adicionar' }}
            </button>
        </div>
    </form>

    <!-- TABELA DE MOVIMENTA√á√ïES -->
    <table>
        <thead>
            <tr>
                <th>Data Compra</th>
                <th>Vencimento</th>
                <th>Descri√ß√£o</th>
                <th>Categoria</th>
                <th>Cart√£o</th>
                <th>Parcela</th>
                <th>Valor</th>
                <th>Tipo</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for m in movimentacoes %}
                <tr>
                    <td>{{ m.data }}</td>
                    <td>{{ m.data_pagamento }}</td>
                    <td>{{ m.descricao }}</td>
                    <td>{{ m.categoria }}</td>
                    <td>
                        {% if m.cartao %}
                            {{ m.cartao['bandeira'] }} / {{ m.cartao['nome'] }}
                        {% else %}
                            <em>N√£o vinculado</em>
                        {% endif %}
                    </td>
                    <td>{{ m.parcela_numero }} / {{ m.parcelas }}</td>
                    <td class="{{ 'positivo' if m.tipo == 'receita' else 'negativo' }}">
                        {{ m.valor | format_currency }}
                    </td>
                    <td>{{ m.tipo.capitalize() }}</td>
                    <td>
                        <form method="post" action="{{ url_for('index') }}" style="display:inline;">
                            <input type="hidden" name="movimentacao_id" value="{{ m.id }}">
                            <input type="hidden" name="paga" value="{{ 0 if m.paga else 1 }}">
                            <input type="hidden" name="alterar_status_parcela" value="1">
                            <button type="submit" class="btn-status {{ 'paga' if m.paga else 'pendente' }}">
                                {{ 'Pago' if m.paga else 'Pendente' }}
                            </button>
                        </form>
                    </td>
                    <td>
                        <!-- Bot√£o Editar -->
                        <a href="{{ url_for('index', edit_id=m.id) }}" class="btn-editar" title="Editar">‚úèÔ∏è</a>

                        <!-- Bot√£o Excluir -->
                        <form method="post" style="display:inline;">
                            <input type="hidden" name="movimentacao_id" value="{{ m.id }}">
                            <button type="submit" name="excluir_movimentacao" class="btn-excluir">üóëÔ∏è</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="6"><strong>Total:</strong></td>
                <td colspan="3">
                    <strong class="{{ 'positivo' if total >= 0 else 'negativo' }}">
                        R$ {{ '%.2f'|format(total) }}
                    </strong>
                </td>
            </tr>
        </tfoot>
    </table>
</body>
</html>
